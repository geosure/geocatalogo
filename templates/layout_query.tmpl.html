{{define "layout_query"}}{{template "layout" .}}{{end}}

{{define "page_title"}}Query Builder â€¢ GRO Catalog{{end}}

{{define "page_content"}}
  <div class="muted" style="margin-bottom:16px;font-size:13px">
    <a href="/" style="color:var(--link)">Catalog</a>
    <span class="sep">â†’</span>
    <span>Query Builder</span>
  </div>

  <h1>ğŸ¯ GRO Catalog Query Builder</h1>
  <p class="muted" style="margin-bottom:24px">
    Build and test queries using the GRO RESTful API (port 9000). Navigate through 5 dimensions: Collections, Formats, Status, Ownership, and Geography.
  </p>

  <div style="font-size:13px;color:#94a3b8;margin-bottom:24px">
    7 AI agents â€¢ 47 database tables â€¢ 474 local files â€¢ 627 v6 jobs â€¢ 541 external sources
  </div>

  <!-- 5 Dimensions Navigation -->
  <section style="margin-bottom:24px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px">
    <div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Browse by Dimension</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a href="/query" style="text-decoration:none;background:#fff;border:1px solid #3b82f6;color:#334155;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px">
        ğŸ” Unified Search
      </a>
      <a href="/collections" style="text-decoration:none;background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px"
         onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff'"
         onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#fff'">
        ğŸ“š Collections
      </a>
      <a href="/stats#formats" style="text-decoration:none;background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px"
         onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff'"
         onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#fff'">
        ğŸ“¦ Formats
      </a>
      <a href="/owners" style="text-decoration:none;background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px"
         onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff'"
         onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#fff'">
        ğŸ‘¥ Ownership
      </a>
      <a href="/geography/continents" style="text-decoration:none;background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px"
         onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff'"
         onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#fff'">
        ğŸŒ Geography
      </a>
    </div>
  </section>

  <!-- Interactive Query Builder -->
  <section class="card" style="background:#f8fafc;border:1px solid #cbd5e1">
    <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;padding:20px">
      <!-- 5 Dimensions Selection -->
      <div style="margin-bottom:20px">
        <div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Select Dimension</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="query-type-btn active" data-type="unified" style="background:#fff;border:1px solid #3b82f6;color:#334155;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s">ğŸ” Unified Search</button>
          <button class="query-type-btn" data-type="collection" style="background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s">ğŸ“š Collections</button>
          <button class="query-type-btn" data-type="format" style="background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s">ğŸ“¦ Formats</button>
          <button class="query-type-btn" data-type="status" style="background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s">ğŸš¦ Status</button>
          <button class="query-type-btn" data-type="owner" style="background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s">ğŸ‘¥ Ownership</button>
          <button class="query-type-btn" data-type="geography" style="background:#fff;border:1px solid #cbd5e1;color:#475569;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s">ğŸŒ Geography</button>
        </div>
      </div>

      <!-- Property Filter Builder -->
      <div id="property-builder" style="display:block">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-bottom:16px">
          <!-- Geographic Filters -->
          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Continent</label>
            <select id="filter-continent" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="clankr">ğŸ¤– Clankr (Operations)</option>
              <option value="north_america">ğŸŒ North America</option>
              <option value="south_america">ğŸŒ South America</option>
              <option value="africa">ğŸŒ Africa</option>
              <option value="europe">ğŸŒ Europe</option>
              <option value="asia">ğŸŒ Asia</option>
              <option value="oceania">ğŸŒ Oceania</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Country</label>
            <input type="text" id="filter-country" class="filter-input" placeholder="e.g., colombia, united_states" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
          </div>

          <!-- Metadata Filters -->
          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Collection</label>
            <select id="filter-collection" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="ai_agent">ğŸ¤– AI Agents</option>
              <option value="existing_db">ğŸ—„ï¸ Database Tables</option>
              <option value="automation_bot">âš™ï¸ Automation Bots</option>
              <option value="catalog_management_bot">ğŸ“‹ Catalog Bots</option>
              <option value="potential_v6">ğŸ“‚ v6 Jobs</option>
              <option value="external_source">ğŸŒ External Sources</option>
              <option value="data_file">ğŸ“„ Data Files</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Status</label>
            <select id="filter-status" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="active">âœ… Active</option>
              <option value="implemented">âœ… Implemented</option>
              <option value="draft">ğŸ“ Draft</option>
              <option value="deprecated">âš ï¸ Deprecated</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Data Format</label>
            <select id="filter-data-format" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="database">ğŸ—„ï¸ Database</option>
              <option value="python_script">ğŸ Python Script</option>
              <option value="yaml">ğŸ“‹ YAML</option>
              <option value="csv">ğŸ“Š CSV</option>
              <option value="parquet">ğŸ“¦ Parquet</option>
              <option value="shapefile">ğŸ—ºï¸ Shapefile</option>
              <option value="geopackage">ğŸ“¦ GeoPackage</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Owner</label>
            <input type="text" id="filter-owner" class="filter-input" placeholder="e.g., @clankr, @data-platform" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
          </div>
        </div>

        <!-- Advanced Filters (Collapsible) -->
        <div style="margin-bottom:16px">
          <button id="toggle-advanced" style="background:#f3f4f6;border:1px solid #d1d5db;color:#374151;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:13px">
            + Show Advanced Filters
          </button>
        </div>

        <div id="advanced-filters" style="display:none;margin-bottom:16px">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Database Table</label>
              <input type="text" id="filter-database-table" class="filter-input" placeholder="e.g., raw_articles" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">v6 Job Type</label>
              <select id="filter-v6-job-type" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
                <option value="">Any</option>
                <option value="bootstrap">Bootstrap</option>
                <option value="collector">Collector</option>
                <option value="inference">Inference</option>
                <option value="run">Run</option>
              </select>
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">City</label>
              <input type="text" id="filter-city" class="filter-input" placeholder="e.g., los_angeles" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Geographic Scope</label>
              <select id="filter-geographic-scope" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
                <option value="">Any</option>
                <option value="global">ğŸŒ Global</option>
                <option value="regional">ğŸ—ºï¸ Regional</option>
                <option value="national">ğŸ³ï¸ National</option>
                <option value="local">ğŸ“ Local</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Text Search Builder -->
      <div id="text-builder" style="display:none;margin-bottom:16px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Search Query:</label>
        <input type="text" id="text-query" placeholder="e.g., database, Lambda deployment, news articles" style="width:100%;padding:12px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:16px">
      </div>

      <!-- Record ID Builder -->
      <div id="recordid-builder" style="display:none;margin-bottom:16px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Record ID(s):</label>
        <input type="text" id="recordid-query" placeholder="e.g., clankr_catalog_agent or clankr_agent,clankr_infra_agent" style="width:100%;padding:12px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:16px">
        <p style="margin:8px 0 0;font-size:12px;opacity:0.8">Comma-separated for multiple records</p>
      </div>

      <!-- Result Limit -->
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Max Results:</label>
        <input type="number" id="max-records" value="10" min="1" max="1000" style="width:120px;padding:8px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
      </div>

      <!-- Generated URL -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:16px;margin-bottom:16px">
        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;color:#1e293b">Generated API URL:</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="generated-url" readonly style="flex:1;padding:10px;border-radius:4px;border:1px solid #cbd5e1;background:#ffffff;color:#1f2937;font-family:monospace;font-size:12px">
          <button id="copy-url-btn" style="background:#e0e7ff;border:1px solid #818cf8;color:#3730a3;padding:10px 16px;border-radius:4px;cursor:pointer;white-space:nowrap;font-weight:500">Copy</button>
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="run-query-btn" style="background:#10b981;border:none;color:white;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600;font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
          â–¶ï¸ Run Query
        </button>
        <button id="clear-filters-btn" style="background:#f3f4f6;border:1px solid #d1d5db;color:#374151;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600">
          ğŸ—‘ï¸ Clear All
        </button>
        <button id="example-btn" style="background:#e0e7ff;border:1px solid #818cf8;color:#3730a3;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600">
          ğŸ’¡ Load Example
        </button>
      </div>
    </div>
  </section>

  <!-- Query Results -->
  <section class="card" id="results-section" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="margin:0">ğŸ“Š Query Results</h2>
      <div id="result-stats" style="font-size:14px;color:#64748b"></div>
    </div>

    <div id="results-container"></div>
  </section>

  <!-- How to Query the Catalog -->
  <section class="card" style="background:#f8fafc;border:1px solid #cbd5e1">
    <h2 style="margin:0 0 16px;color:#334155">ğŸ¯ How to Query with GRO API (For Humans & Agents)</h2>
    <p style="margin:0 0 20px;color:#475569;font-size:15px;line-height:1.7">
      The GRO RESTful API provides <strong>5-dimensional navigation</strong> for the entire GRO data universe.
      All catalog metadata lives in <code style="background:#e2e8f0;padding:2px 6px;border-radius:3px">properties.gro_metadata</code>.
    </p>

    <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;padding:20px">
      <h3 style="margin:0 0 16px;color:#334155">ğŸ”Œ API Base URL</h3>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px;font-family:monospace;color:#475569;font-size:14px;margin-bottom:16px">
        http://localhost:9000/api/v1
      </div>

      <h3 style="margin:16px 0 10px;color:#475569;font-size:14px;font-weight:500">Five Dimensions</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
        <div style="background:#fafafa;border:1px solid #e5e7eb;border-radius:4px;padding:8px 12px">
          <div style="font-weight:500;color:#475569;font-size:13px">Collections <span style="color:#94a3b8">Â· 21</span></div>
        </div>
        <div style="background:#fafafa;border:1px solid #e5e7eb;border-radius:4px;padding:8px 12px">
          <div style="font-weight:500;color:#475569;font-size:13px">Formats <span style="color:#94a3b8">Â· 56</span></div>
        </div>
        <div style="background:#fafafa;border:1px solid #e5e7eb;border-radius:4px;padding:8px 12px">
          <div style="font-weight:500;color:#475569;font-size:13px">Status <span style="color:#94a3b8">Â· 12</span></div>
        </div>
        <div style="background:#fafafa;border:1px solid #e5e7eb;border-radius:4px;padding:8px 12px">
          <div style="font-weight:500;color:#475569;font-size:13px">Ownership <span style="color:#94a3b8">Â· 32</span></div>
        </div>
        <div style="background:#fafafa;border:1px solid #e5e7eb;border-radius:4px;padding:8px 12px">
          <div style="font-weight:500;color:#475569;font-size:13px">Geography <span style="color:#94a3b8">Â· 4 levels</span></div>
        </div>
      </div>

      <h3 style="margin:20px 0 12px;color:#334155">ğŸ’¡ Example Queries</h3>
      <div style="background:#f8fafc;border-radius:6px;padding:16px;font-family:monospace;font-size:12px;line-height:2">
        <div><span style="color:#64748b"># List all collections</span></div>
        <div>GET /api/v1/collections</div>
        <br>
        <div><span style="color:#64748b"># Get all AI agents</span></div>
        <div>GET /api/v1/collections/ai_agent</div>
        <br>
        <div><span style="color:#64748b"># List all continents</span></div>
        <div>GET /api/v1/geography/continents</div>
        <br>
        <div><span style="color:#64748b"># Unified search with filters</span></div>
        <div>GET /api/v1/resources?collection=ai_agent&status=active</div>
      </div>
    </div>
  </section>

  <!-- Quick Tips -->
  <section class="card" style="background:#f0fdf4;border:1px solid #bbf7d0">
    <h3 style="margin:0 0 12px;color:#15803d">ğŸ’¡ Quick Tips</h3>
    <ul style="margin:0;padding-left:20px;color:#166534;line-height:2">
      <li>Use <strong>ğŸ” Unified Search</strong> to combine multiple filters across all dimensions</li>
      <li>Use <strong>ğŸ“š Collections</strong> to browse by resource type (AI agents, databases, etc.)</li>
      <li>Use <strong>ğŸ“¦ Formats</strong> to find resources by data format (CSV, API, Lambda, etc.)</li>
      <li>Use <strong>ğŸš¦ Status</strong> to filter by deployment state (active, draft, implemented)</li>
      <li>Use <strong>ğŸ‘¥ Owner</strong> to see what each team owns</li>
      <li>Use <strong>ğŸŒ Geography</strong> to navigate the 4-level hierarchy (continent â†’ country â†’ state â†’ city)</li>
      <li>Check the <a href="/api-docs" style="color:#15803d;font-weight:600">API Docs</a> for complete endpoint reference</li>
    </ul>
  </section>
{{end}}

{{define "scripts_extra"}}
<style>
.result-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  padding: 12px;
  margin-bottom: 10px;
  transition: all 0.15s;
}

.result-card:hover {
  border-color: #cbd5e1;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.query-type-btn.active {
  background: #fff !important;
  border-color: #3b82f6 !important;
  color: #334155 !important;
}

.query-type-btn:hover {
  border-color: #3b82f6 !important;
  background: #eff6ff !important;
}
</style>

<script>
const API_BASE = 'http://localhost:9000/api/v1';
const generatedUrl = document.getElementById('generated-url');
const resultsSection = document.getElementById('results-section');
const resultsContainer = document.getElementById('results-container');
const resultStats = document.getElementById('result-stats');
const toggleAdvancedBtn = document.getElementById('toggle-advanced');
const advancedFilters = document.getElementById('advanced-filters');

// Query dimension switching
document.querySelectorAll('.query-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // Update button states
    document.querySelectorAll('.query-type-btn').forEach(b => {
      b.classList.remove('active');
      b.style.background = '#fff';
      b.style.borderColor = '#cbd5e1';
      b.style.color = '#475569';
    });
    btn.classList.add('active');
    btn.style.background = '#fff';
    btn.style.borderColor = '#3b82f6';
    btn.style.color = '#334155';

    // All dimension types use the same property builder interface
    document.getElementById('property-builder').style.display = 'block';

    updateGeneratedUrl();
  });
});

// Toggle advanced filters
toggleAdvancedBtn.addEventListener('click', () => {
  const isVisible = advancedFilters.style.display === 'block';
  advancedFilters.style.display = isVisible ? 'none' : 'block';
  toggleAdvancedBtn.textContent = isVisible ? '+ Show Advanced Filters' : '- Hide Advanced Filters';
});

// Update URL as filters change AND auto-run query
document.querySelectorAll('.filter-input, #text-query, #recordid-query, #max-records').forEach(input => {
  input.addEventListener('input', () => {
    updateGeneratedUrl();
    autoRunQuery();
  });
  input.addEventListener('change', () => {
    updateGeneratedUrl();
    autoRunQuery();
  });
});

function updateGeneratedUrl() {
  const activeType = document.querySelector('.query-type-btn.active').dataset.type;
  const params = new URLSearchParams();
  let url = API_BASE;

  if (activeType === 'unified') {
    // Unified search with multiple filters
    const filters = {
      collection: document.getElementById('filter-collection').value,
      status: document.getElementById('filter-status').value,
      data_format: document.getElementById('filter-data-format').value,
      owner: document.getElementById('filter-owner').value,
      continent: document.getElementById('filter-continent').value,
      country: document.getElementById('filter-country').value,
      city: document.getElementById('filter-city').value,
      database_table: document.getElementById('filter-database-table').value,
      v6_job_type: document.getElementById('filter-v6-job-type').value,
      geographic_scope: document.getElementById('filter-geographic-scope').value
    };

    Object.entries(filters).forEach(([key, value]) => {
      if (value) params.append(key, value);
    });

    const maxRecords = document.getElementById('max-records').value;
    if (maxRecords && maxRecords !== '10') params.append('size', maxRecords);

    url = `${API_BASE}/resources${params.toString() ? '?' + params.toString() : ''}`;
  } else if (activeType === 'collection') {
    const collection = document.getElementById('filter-collection').value;
    url = collection ? `${API_BASE}/collections/${collection}` : `${API_BASE}/collections`;
  } else if (activeType === 'format') {
    const format = document.getElementById('filter-data-format').value;
    url = format ? `${API_BASE}/formats/${format}` : `${API_BASE}/formats`;
  } else if (activeType === 'status') {
    const status = document.getElementById('filter-status').value;
    url = status ? `${API_BASE}/statuses/${status}` : `${API_BASE}/statuses`;
  } else if (activeType === 'owner') {
    const owner = document.getElementById('filter-owner').value;
    url = owner ? `${API_BASE}/owners/${encodeURIComponent(owner)}` : `${API_BASE}/owners`;
  } else if (activeType === 'geography') {
    const continent = document.getElementById('filter-continent').value;
    const country = document.getElementById('filter-country').value;
    const city = document.getElementById('filter-city').value;

    if (city && country && continent) {
      url = `${API_BASE}/geography/continents/${continent}/countries/${country}/cities/${city}`;
    } else if (country && continent) {
      url = `${API_BASE}/geography/continents/${continent}/countries/${country}`;
    } else if (continent) {
      url = `${API_BASE}/geography/continents/${continent}`;
    } else {
      url = `${API_BASE}/geography/continents`;
    }
  }

  generatedUrl.value = url;
}

// Auto-run query when filters change (debounced)
let autoQueryTimeout;
function autoRunQuery() {
  clearTimeout(autoQueryTimeout);
  autoQueryTimeout = setTimeout(() => {
    const url = generatedUrl.value;
    if (url && url !== API_BASE) {
      runQueryRequest(url);
    }
  }, 500); // 500ms debounce
}

// Copy URL to clipboard
document.getElementById('copy-url-btn').addEventListener('click', () => {
  generatedUrl.select();
  document.execCommand('copy');

  const btn = document.getElementById('copy-url-btn');
  const originalText = btn.textContent;
  btn.textContent = 'âœ“ Copied!';
  setTimeout(() => btn.textContent = originalText, 2000);
});

// Clear all filters
document.getElementById('clear-filters-btn').addEventListener('click', () => {
  document.querySelectorAll('.filter-input').forEach(input => {
    if (input.tagName === 'SELECT') {
      input.selectedIndex = 0;
    } else {
      input.value = '';
    }
  });
  document.getElementById('text-query').value = '';
  document.getElementById('recordid-query').value = '';
  document.getElementById('max-records').value = '10';
  updateGeneratedUrl();
  resultsSection.style.display = 'none';
});

// Load example query
document.getElementById('example-btn').addEventListener('click', () => {
  // Set to unified search mode
  document.querySelector('[data-type="unified"]').click();

  // Set example filters - Find active AI agents in clankr
  document.getElementById('filter-collection').value = 'ai_agent';
  document.getElementById('filter-status').value = 'active';
  document.getElementById('filter-continent').value = 'clankr';
  document.getElementById('max-records').value = '10';

  updateGeneratedUrl();
  autoRunQuery();
});

// Run query function (reusable)
async function runQueryRequest(url) {
  if (!url || url === API_BASE) {
    return;
  }

  // Show loading state
  resultsSection.style.display = 'block';
  resultsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b">â³ Loading results...</div>';
  resultStats.textContent = '';

  try {
    const response = await fetch(url);
    const data = await response.json();

    // Update stats (handle both GRO and legacy API formats)
    const matched = data.matched || data.Matches || 0;
    const returned = data.returned || data.Returned || (data.records ? data.records.length : 0);
    resultStats.textContent = `Found ${matched} matches, showing ${returned}`;

    // Render results with beautiful cards
    if (data.records && data.records.length > 0) {
      resultsContainer.innerHTML = data.records.map(record => {
        const props = record.properties;
        const gro = props.gro_metadata || {};

        // Collection emoji mapping
        const collectionEmojis = {
          'ai_agent': 'ğŸ¤–',
          'existing_db': 'ğŸ—„ï¸',
          'existing_local': 'ğŸ“',
          'potential_v6': 'ğŸ“‹',
          'external_api': 'ğŸŒ',
          'automation_bot': 'âš™ï¸',
          'operational_service': 'ğŸ”§',
          'infrastructure': 'ğŸ—ï¸'
        };

        // Status indicators (subtle)
        const statusIndicators = {
          'active': 'âœ“',
          'implemented': 'âœ“',
          'deployed': 'â†‘',
          'draft': 'â—‹',
          'potential': 'â—‡',
          'archived': 'â–¡'
        };

        const statusIcon = statusIndicators[gro.implementation_status] || 'Â·';

        return `
          <div class="result-card">
            <!-- Compact header -->
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;margin-bottom:8px">
              <div style="flex:1;min-width:0">
                <h3 style="margin:0 0 4px;color:#1e293b;font-size:15px;font-weight:600">${props.title || record.id}</h3>
                <div style="font-size:11px;color:#94a3b8;font-family:monospace">${record.id}</div>
              </div>
            </div>

            <!-- Compact pills -->
            <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">
              ${props.collection ? `<span style="background:#f1f5f9;color:#475569;padding:2px 8px;border-radius:3px;font-size:11px;font-weight:500">${props.collection.replace(/_/g, ' ')}</span>` : ''}
              ${gro.implementation_status ? `<span style="background:#f8fafc;color:#64748b;padding:2px 8px;border-radius:3px;font-size:11px">${statusIcon} ${gro.implementation_status}</span>` : ''}
              ${gro.data_format ? `<span style="background:#fafaf9;color:#78716c;padding:2px 8px;border-radius:3px;font-size:11px">${gro.data_format}</span>` : ''}
            </div>

            <!-- Compact description -->
            ${props.abstract ? `<p style="margin:0 0 8px;color:#64748b;font-size:13px;line-height:1.5">${props.abstract.substring(0, 180)}${props.abstract.length > 180 ? '...' : ''}</p>` : ''}

            <!-- Compact metadata -->
            <div style="display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:#94a3b8">
              ${gro.continent ? `<span>${gro.continent.replace(/_/g, ' ')}</span>` : ''}
              ${gro.country ? `<span>Â· ${gro.country}</span>` : ''}
              ${gro.owner ? `<span>Â· ${gro.owner}</span>` : ''}
              ${gro.database_table ? `<span>Â· <code style="font-size:11px">${gro.database_table}</code></span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      resultsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:16px">ğŸ˜” No results found. Try adjusting your filters.</div>';
    }

  } catch (error) {
    resultsContainer.innerHTML = `<div style="background:#fee;border:1px solid #fcc;border-radius:6px;padding:16px;color:#c00">
      <strong>Error:</strong> ${error.message}
    </div>`;
  }
}

// Run query button
document.getElementById('run-query-btn').addEventListener('click', () => {
  const url = generatedUrl.value;
  if (!url || url === API_BASE) {
    alert('Please configure at least one filter, search term, or record ID');
    return;
  }
  runQueryRequest(url);
});

// Initialize
updateGeneratedUrl();
</script>
{{end}}
