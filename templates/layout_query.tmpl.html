{{define "layout_query"}}{{template "layout" .}}{{end}}

{{define "page_title"}}Query Builder • GRO Catalog{{end}}

{{define "page_content"}}
  <div class="muted" style="margin-bottom:16px;font-size:13px">
    <a href="/" style="color:var(--link)">Catalog</a>
    <span class="sep">→</span>
    <span>Query Builder</span>
  </div>

  <h1>🎯 Interactive Query Builder</h1>
  <p class="muted" style="margin-bottom:32px">
    Build and test queries directly in your browser. Click "Run Query" to see live results.
  </p>

  <!-- Interactive Query Builder -->
  <section class="card" style="background:#f8fafc;border:1px solid #cbd5e1">
    <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;padding:20px">
      <!-- Query Type Selection -->
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#1e293b">Query Type:</label>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="query-type-btn active" data-type="property" style="background:#e0e7ff;border:2px solid #818cf8;color:#3730a3;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600">Property Filters</button>
          <button class="query-type-btn" data-type="text" style="background:#f3f4f6;border:2px solid #d1d5db;color:#374151;padding:8px 16px;border-radius:6px;cursor:pointer">Text Search</button>
          <button class="query-type-btn" data-type="recordid" style="background:#f3f4f6;border:2px solid #d1d5db;color:#374151;padding:8px 16px;border-radius:6px;cursor:pointer">Record ID</button>
        </div>
      </div>

      <!-- Property Filter Builder -->
      <div id="property-builder" style="display:block">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-bottom:16px">
          <!-- Geographic Filters -->
          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Continent</label>
            <select id="filter-continent" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="clankr">🤖 Clankr (Operations)</option>
              <option value="north_america">🌎 North America</option>
              <option value="south_america">🌎 South America</option>
              <option value="africa">🌍 Africa</option>
              <option value="europe">🌍 Europe</option>
              <option value="asia">🌏 Asia</option>
              <option value="oceania">🌏 Oceania</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Country</label>
            <input type="text" id="filter-country" class="filter-input" placeholder="e.g., colombia, united_states" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
          </div>

          <!-- Metadata Filters -->
          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Collection</label>
            <select id="filter-collection" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="ai_agent">🤖 AI Agents</option>
              <option value="existing_db">🗄️ Database Tables</option>
              <option value="automation_bot">⚙️ Automation Bots</option>
              <option value="catalog_management_bot">📋 Catalog Bots</option>
              <option value="potential_v6">📂 v6 Jobs</option>
              <option value="external_source">🌐 External Sources</option>
              <option value="data_file">📄 Data Files</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Status</label>
            <select id="filter-status" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="active">✅ Active</option>
              <option value="implemented">✅ Implemented</option>
              <option value="draft">📝 Draft</option>
              <option value="deprecated">⚠️ Deprecated</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Data Format</label>
            <select id="filter-data-format" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
              <option value="">Any</option>
              <option value="database">🗄️ Database</option>
              <option value="python_script">🐍 Python Script</option>
              <option value="yaml">📋 YAML</option>
              <option value="csv">📊 CSV</option>
              <option value="parquet">📦 Parquet</option>
              <option value="shapefile">🗺️ Shapefile</option>
              <option value="geopackage">📦 GeoPackage</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Owner</label>
            <input type="text" id="filter-owner" class="filter-input" placeholder="e.g., @clankr, @data-platform" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
          </div>
        </div>

        <!-- Advanced Filters (Collapsible) -->
        <div style="margin-bottom:16px">
          <button id="toggle-advanced" style="background:#f3f4f6;border:1px solid #d1d5db;color:#374151;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:13px">
            + Show Advanced Filters
          </button>
        </div>

        <div id="advanced-filters" style="display:none;margin-bottom:16px">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Database Table</label>
              <input type="text" id="filter-database-table" class="filter-input" placeholder="e.g., raw_articles" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">v6 Job Type</label>
              <select id="filter-v6-job-type" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
                <option value="">Any</option>
                <option value="bootstrap">Bootstrap</option>
                <option value="collector">Collector</option>
                <option value="inference">Inference</option>
                <option value="run">Run</option>
              </select>
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">City</label>
              <input type="text" id="filter-city" class="filter-input" placeholder="e.g., los_angeles" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;color:#475569;font-weight:500">Geographic Scope</label>
              <select id="filter-geographic-scope" class="filter-input" style="width:100%;padding:8px;border-radius:4px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
                <option value="">Any</option>
                <option value="global">🌍 Global</option>
                <option value="regional">🗺️ Regional</option>
                <option value="national">🏳️ National</option>
                <option value="local">📍 Local</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Text Search Builder -->
      <div id="text-builder" style="display:none;margin-bottom:16px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Search Query:</label>
        <input type="text" id="text-query" placeholder="e.g., database, Lambda deployment, news articles" style="width:100%;padding:12px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:16px">
      </div>

      <!-- Record ID Builder -->
      <div id="recordid-builder" style="display:none;margin-bottom:16px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Record ID(s):</label>
        <input type="text" id="recordid-query" placeholder="e.g., clankr_catalog_agent or clankr_agent,clankr_infra_agent" style="width:100%;padding:12px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:16px">
        <p style="margin:8px 0 0;font-size:12px;opacity:0.8">Comma-separated for multiple records</p>
      </div>

      <!-- Result Limit -->
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">Max Results:</label>
        <input type="number" id="max-records" value="10" min="1" max="1000" style="width:120px;padding:8px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#1f2937;font-size:14px">
      </div>

      <!-- Generated URL -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:16px;margin-bottom:16px">
        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;color:#1e293b">Generated API URL:</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="generated-url" readonly style="flex:1;padding:10px;border-radius:4px;border:1px solid #cbd5e1;background:#ffffff;color:#1f2937;font-family:monospace;font-size:12px">
          <button id="copy-url-btn" style="background:#e0e7ff;border:1px solid #818cf8;color:#3730a3;padding:10px 16px;border-radius:4px;cursor:pointer;white-space:nowrap;font-weight:500">Copy</button>
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="run-query-btn" style="background:#10b981;border:none;color:white;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600;font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
          ▶️ Run Query
        </button>
        <button id="clear-filters-btn" style="background:#f3f4f6;border:1px solid #d1d5db;color:#374151;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600">
          🗑️ Clear All
        </button>
        <button id="example-btn" style="background:#e0e7ff;border:1px solid #818cf8;color:#3730a3;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600">
          💡 Load Example
        </button>
      </div>
    </div>
  </section>

  <!-- Query Results -->
  <section class="card" id="results-section" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="margin:0">📊 Query Results</h2>
      <div id="result-stats" style="font-size:14px;color:#64748b"></div>
    </div>

    <div id="results-container"></div>
  </section>

  <!-- Quick Tips -->
  <section class="card" style="background:#f0fdf4;border:1px solid #bbf7d0">
    <h3 style="margin:0 0 12px;color:#15803d">💡 Quick Tips</h3>
    <ul style="margin:0;padding-left:20px;color:#166534;line-height:2">
      <li>Use <strong>Property Filters</strong> for precise, structured queries (recommended for agents)</li>
      <li>Use <strong>Text Search</strong> for fuzzy matching across titles and descriptions</li>
      <li>Use <strong>Record ID</strong> to fetch specific catalog entries by ID</li>
      <li>Combine multiple property filters for powerful queries (they work with AND logic)</li>
      <li>Check the <a href="/api-docs" style="color:#15803d;font-weight:600">API Docs</a> for complete property filter reference</li>
    </ul>
  </section>
{{end}}

{{define "scripts_extra"}}
<style>
.result-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  transition: all 0.2s;
}

.result-card:hover {
  border-color: #3b82f6;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

.query-type-btn.active {
  background: #e0e7ff !important;
  border-color: #818cf8 !important;
  color: #3730a3 !important;
}
</style>

<script>
const API_BASE = 'http://localhost:8000';
const generatedUrl = document.getElementById('generated-url');
const resultsSection = document.getElementById('results-section');
const resultsContainer = document.getElementById('results-container');
const resultStats = document.getElementById('result-stats');
const toggleAdvancedBtn = document.getElementById('toggle-advanced');
const advancedFilters = document.getElementById('advanced-filters');

// Query type switching
document.querySelectorAll('.query-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // Update button states
    document.querySelectorAll('.query-type-btn').forEach(b => {
      b.classList.remove('active');
      b.style.background = '#f3f4f6';
      b.style.borderColor = '#d1d5db';
      b.style.color = '#374151';
    });
    btn.classList.add('active');

    // Show/hide builders
    const type = btn.dataset.type;
    document.getElementById('property-builder').style.display = type === 'property' ? 'block' : 'none';
    document.getElementById('text-builder').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('recordid-builder').style.display = type === 'recordid' ? 'block' : 'none';

    updateGeneratedUrl();
  });
});

// Toggle advanced filters
toggleAdvancedBtn.addEventListener('click', () => {
  const isVisible = advancedFilters.style.display === 'block';
  advancedFilters.style.display = isVisible ? 'none' : 'block';
  toggleAdvancedBtn.textContent = isVisible ? '+ Show Advanced Filters' : '- Hide Advanced Filters';
});

// Update URL as filters change AND auto-run query
document.querySelectorAll('.filter-input, #text-query, #recordid-query, #max-records').forEach(input => {
  input.addEventListener('input', () => {
    updateGeneratedUrl();
    autoRunQuery();
  });
  input.addEventListener('change', () => {
    updateGeneratedUrl();
    autoRunQuery();
  });
});

function updateGeneratedUrl() {
  const activeType = document.querySelector('.query-type-btn.active').dataset.type;
  const params = new URLSearchParams();

  if (activeType === 'property') {
    // Add property filters
    const filters = {
      continent: document.getElementById('filter-continent').value,
      country: document.getElementById('filter-country').value,
      collection: document.getElementById('filter-collection').value,
      status: document.getElementById('filter-status').value,
      data_format: document.getElementById('filter-data-format').value,
      owner: document.getElementById('filter-owner').value,
      database_table: document.getElementById('filter-database-table').value,
      v6_job_type: document.getElementById('filter-v6-job-type').value,
      city: document.getElementById('filter-city').value,
      geographic_scope: document.getElementById('filter-geographic-scope').value
    };

    Object.entries(filters).forEach(([key, value]) => {
      if (value) params.append(key, value);
    });
  } else if (activeType === 'text') {
    const query = document.getElementById('text-query').value;
    if (query) params.append('q', query);
  } else if (activeType === 'recordid') {
    const recordids = document.getElementById('recordid-query').value;
    if (recordids) params.append('recordids', recordids);
  }

  const maxRecords = document.getElementById('max-records').value;
  if (maxRecords && maxRecords !== '10') params.append('maxrecords', maxRecords);

  const url = params.toString() ? `${API_BASE}/?${params.toString()}` : API_BASE;
  generatedUrl.value = url;
}

// Auto-run query when filters change (debounced)
let autoQueryTimeout;
function autoRunQuery() {
  clearTimeout(autoQueryTimeout);
  autoQueryTimeout = setTimeout(() => {
    const url = generatedUrl.value;
    if (url && url !== API_BASE) {
      runQueryRequest(url);
    }
  }, 500); // 500ms debounce
}

// Copy URL to clipboard
document.getElementById('copy-url-btn').addEventListener('click', () => {
  generatedUrl.select();
  document.execCommand('copy');

  const btn = document.getElementById('copy-url-btn');
  const originalText = btn.textContent;
  btn.textContent = '✓ Copied!';
  setTimeout(() => btn.textContent = originalText, 2000);
});

// Clear all filters
document.getElementById('clear-filters-btn').addEventListener('click', () => {
  document.querySelectorAll('.filter-input').forEach(input => {
    if (input.tagName === 'SELECT') {
      input.selectedIndex = 0;
    } else {
      input.value = '';
    }
  });
  document.getElementById('text-query').value = '';
  document.getElementById('recordid-query').value = '';
  document.getElementById('max-records').value = '10';
  updateGeneratedUrl();
  resultsSection.style.display = 'none';
});

// Load example query
document.getElementById('example-btn').addEventListener('click', () => {
  // Set to property filter mode
  document.querySelector('[data-type="property"]').click();

  // Set example filters
  document.getElementById('filter-continent').value = 'clankr';
  document.getElementById('filter-collection').value = 'ai_agent';
  document.getElementById('filter-status').value = 'active';
  document.getElementById('max-records').value = '10';

  updateGeneratedUrl();
});

// Run query function (reusable)
async function runQueryRequest(url) {
  if (!url || url === API_BASE) {
    return;
  }

  // Show loading state
  resultsSection.style.display = 'block';
  resultsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b">⏳ Loading results...</div>';
  resultStats.textContent = '';

  try {
    const response = await fetch(url);
    const data = await response.json();

    // Update stats
    resultStats.textContent = `Found ${data.Matches} matches, showing ${data.Returned}`;

    // Render results
    if (data.Records && data.Records.length > 0) {
      resultsContainer.innerHTML = data.Records.map(record => {
        const props = record.properties;
        const gro = props.gro_metadata || {};

        return `
          <div class="result-card">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <div>
                <h3 style="margin:0 0 4px;color:#0f172a;font-size:16px">${props.title || record.id}</h3>
                <div style="font-size:13px;color:#64748b;font-family:monospace">${record.id}</div>
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                ${props.collection ? `<span style="background:#dbeafe;color:#1e40af;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">${props.collection}</span>` : ''}
                ${gro.implementation_status ? `<span style="background:#dcfce7;color:#15803d;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">${gro.implementation_status}</span>` : ''}
              </div>
            </div>

            ${props.abstract ? `<p style="margin:0 0 12px;color:#475569;font-size:14px;line-height:1.5">${props.abstract.substring(0, 200)}${props.abstract.length > 200 ? '...' : ''}</p>` : ''}

            <div style="display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:#64748b">
              ${gro.continent ? `<span>🌍 ${gro.continent}</span>` : ''}
              ${gro.country ? `<span>🏳️ ${gro.country}</span>` : ''}
              ${gro.data_format ? `<span>📦 ${gro.data_format}</span>` : ''}
              ${gro.owner ? `<span>👤 ${gro.owner}</span>` : ''}
            </div>

            <div style="margin-top:12px">
              <a href="${API_BASE}/?recordids=${record.id}" target="_blank" style="color:#0b63ce;text-decoration:none;font-size:13px;font-weight:500">
                View Full Record →
              </a>
            </div>
          </div>
        `;
      }).join('');
    } else {
      resultsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b">No results found. Try adjusting your filters.</div>';
    }

  } catch (error) {
    resultsContainer.innerHTML = `<div style="background:#fee;border:1px solid #fcc;border-radius:6px;padding:16px;color:#c00">
      <strong>Error:</strong> ${error.message}
    </div>`;
  }
}

// Run query button
document.getElementById('run-query-btn').addEventListener('click', () => {
  const url = generatedUrl.value;
  if (!url || url === API_BASE) {
    alert('Please configure at least one filter, search term, or record ID');
    return;
  }
  runQueryRequest(url);
});

// Initialize
updateGeneratedUrl();
</script>
{{end}}
