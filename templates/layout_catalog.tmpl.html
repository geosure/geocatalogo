{{define "layout_catalog"}}{{template "layout" .}}{{end}}

{{define "page_title"}}Data Catalog • GRO{{end}}

{{define "page_content"}}
  <!-- Header + controls -->
  <section class="card card-compact">
    <h1 style="margin:0">GRO Data Catalog</h1>
    <div class="muted">
      <span id="totalCount">{{.Stats.Total}}</span> datasets
      <span class="sep">•</span>
      <span class="hint">Search, filter by collection, format, status</span>
    </div>

    <div class="toolbar" style="gap:8px;flex-wrap:wrap;margin-top:16px">
      <!-- Search -->
      <input id="q" class="search" type="search"
             placeholder="Search datasets..."
             aria-label="Search catalog"
             style="min-width:280px;flex:1">

      <!-- Collection filter -->
      <select id="collection" class="select" aria-label="Filter by collection">
        <option value="">All collections</option>
        <option value="existing_db">Database Tables ({{.Stats.ExistingDB}})</option>
        <option value="existing_local">Local Files ({{.Stats.ExistingLocal}})</option>
        <option value="potential_v6">v6 Jobs ({{.Stats.PotentialV6}})</option>
        <option value="external_api">External APIs ({{.Stats.ExternalAPI}})</option>
        <option value="external_news">News Sources ({{.Stats.ExternalNews}})</option>
        <option value="external_government">Government ({{.Stats.ExternalGov}})</option>
        <option value="external_other">Other External ({{.Stats.ExternalOther}})</option>
      </select>

      <!-- Format filter -->
      <select id="format" class="select" aria-label="Filter by format">
        <option value="">All formats</option>
        <option value="database">Database</option>
        <option value="csv">CSV</option>
        <option value="parquet">Parquet</option>
        <option value="shapefile">Shapefile</option>
        <option value="geopackage">GeoPackage</option>
        <option value="api">API</option>
        <option value="news">News</option>
      </select>

      <!-- Status filter -->
      <select id="status" class="select" aria-label="Filter by status">
        <option value="">All statuses</option>
        <option value="implemented">Implemented</option>
        <option value="draft">Draft</option>
        <option value="potential">Potential</option>
      </select>

      <!-- Sort -->
      <select id="sort" class="select" aria-label="Sort datasets">
        <option value="name_asc">Name (A→Z)</option>
        <option value="name_desc">Name (Z→A)</option>
        <option value="updated_desc">Recently Updated</option>
      </select>
    </div>
  </section>

  <!-- Results grid -->
  <section class="card card-compact">
    <div id="resultCount" class="muted" style="margin-bottom:12px">
      Showing <span id="showing">{{.Stats.Total}}</span> of <span id="total">{{.Stats.Total}}</span> datasets
    </div>

    <ul id="catalogGrid" class="grid-cards reset" style="gap:12px;list-style:none;margin:0;padding:0">
      {{range .Records}}
        <li class="card card-compact dataset"
            data-name="{{.Properties.Title}}"
            data-collection="{{.Properties.Collection}}"
            data-format="{{.Properties.GROMetadata.DataFormat}}"
            data-status="{{.Properties.GROMetadata.ImplementationStatus}}"
            data-country="{{.Properties.GROMetadata.Country}}"
            style="display:flex;flex-direction:column;gap:10px">

          <!-- Title -->
          <h3 style="margin:0;font-size:15px;line-height:1.3;font-weight:700">
            <a href="/dataset/{{.ID}}" style="color:var(--accent);text-decoration:none">
              {{.Properties.Title}}
            </a>
          </h3>

          <!-- Metadata chips -->
          <div class="chips" style="gap:4px;flex-wrap:wrap">
            <!-- Collection -->
            <span class="chip chip-sm" style="background:#eff6ff;color:#1e40af;border-color:#bfdbfe">
              {{.Properties.Collection}}
            </span>

            <!-- Format -->
            {{if .Properties.GROMetadata.DataFormat}}
              <span class="chip chip-sm" style="font-family:monospace;font-size:9px;background:#f5f5f5;color:#404040">
                {{.Properties.GROMetadata.DataFormat}}
              </span>
            {{end}}

            <!-- Status badge -->
            {{if eq .Properties.GROMetadata.ImplementationStatus "implemented"}}
              <span class="chip chip-sm" style="background:#dcfce7;color:#15803d;border-color:#bbf7d0">
                ✓ Implemented
              </span>
            {{else if eq .Properties.GROMetadata.ImplementationStatus "draft"}}
              <span class="chip chip-sm" style="background:#fef3c7;color:#92400e;border-color:#fde68a">
                Draft
              </span>
            {{else}}
              <span class="chip chip-sm" style="background:#f3f4f6;color:#6b7280;border-color:#e5e7eb">
                Potential
              </span>
            {{end}}
          </div>

          <!-- Description -->
          {{if .Properties.Abstract}}
            <p class="snippet" style="margin:0;font-size:13px;color:#374151;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">
              {{.Properties.Abstract}}
            </p>
          {{end}}

          <!-- Location chips -->
          {{if or .Properties.GROMetadata.Country .Properties.GROMetadata.Continent}}
            <div class="chips" style="gap:3px;flex-wrap:wrap">
              {{if .Properties.GROMetadata.Continent}}
                <span class="chip chip-sm" style="font-size:9px;background:#fef2f2;color:#991b1b;border-color:#fecaca">
                  {{.Properties.GROMetadata.Continent}}
                </span>
              {{end}}
              {{if .Properties.GROMetadata.Country}}
                <span class="chip chip-sm" style="font-size:10px;background:#e0f2fe;border-color:#bae6fd;color:#075985">
                  {{upper .Properties.GROMetadata.Country}}
                </span>
              {{end}}
            </div>
          {{end}}
        </li>
      {{end}}
    </ul>

    <!-- No results message -->
    <div id="noResults" class="hidden" style="text-align:center;padding:40px;color:var(--muted)">
      <p style="font-size:16px;margin:0">No datasets match your filters</p>
      <p style="font-size:13px;margin:8px 0 0">Try adjusting your search or filters</p>
    </div>
  </section>
{{end}}

{{define "scripts_extra"}}
<script>
// Client-side filtering (just like Explore!)
const datasets = Array.from(document.querySelectorAll('.dataset'));
const q = document.getElementById('q');
const collection = document.getElementById('collection');
const format = document.getElementById('format');
const status = document.getElementById('status');
const sort = document.getElementById('sort');
const showing = document.getElementById('showing');
const noResults = document.getElementById('noResults');
const catalogGrid = document.getElementById('catalogGrid');

function filter() {
  const query = q.value.toLowerCase().trim();
  const collVal = collection.value;
  const fmtVal = format.value;
  const statVal = status.value;

  let visible = 0;
  datasets.forEach(d => {
    const name = (d.dataset.name || '').toLowerCase();
    const coll = d.dataset.collection || '';
    const fmt = d.dataset.format || '';
    const stat = d.dataset.status || '';

    const matchQuery = !query || name.includes(query);
    const matchColl = !collVal || coll === collVal;
    const matchFmt = !fmtVal || fmt === fmtVal;
    const matchStat = !statVal || stat === statVal;

    if (matchQuery && matchColl && matchFmt && matchStat) {
      d.style.display = '';
      visible++;
    } else {
      d.style.display = 'none';
    }
  });

  showing.textContent = visible;
  noResults.style.display = visible === 0 ? 'block' : 'none';
  catalogGrid.style.display = visible === 0 ? 'none' : 'grid';
}

q.addEventListener('input', filter);
collection.addEventListener('change', filter);
format.addEventListener('change', filter);
status.addEventListener('change', filter);

// Sorting
sort.addEventListener('change', () => {
  const val = sort.value;
  const sorted = [...datasets].sort((a, b) => {
    const nameA = (a.dataset.name || '').toLowerCase();
    const nameB = (b.dataset.name || '').toLowerCase();

    if (val === 'name_asc') return nameA.localeCompare(nameB);
    if (val === 'name_desc') return nameB.localeCompare(nameA);
    return 0;
  });

  sorted.forEach(d => catalogGrid.appendChild(d));
});
</script>
{{end}}
