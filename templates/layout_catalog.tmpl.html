{{define "layout_catalog"}}{{template "layout" .}}{{end}}

{{define "page_title"}}Data Catalog â€¢ GRO{{end}}

{{define "page_content"}}
  <!-- Header + controls -->
  <section class="card card-compact">
    <h1 style="margin:0">GRO Data Catalog</h1>
    <div class="muted">
      <span id="totalCount">{{.Stats.Total}}</span> datasets
      <span class="sep">â€¢</span>
      <span class="hint">Search, filter by collection, format, status</span>
    </div>

    <div class="toolbar" style="gap:8px;flex-wrap:wrap;margin-top:16px">
      <!-- Search -->
      <input id="q" class="search" type="search"
             placeholder="Search datasets..."
             aria-label="Search catalog"
             style="min-width:280px;flex:1">

      <!-- Collection filter -->
      <select id="collection" class="select" aria-label="Filter by collection">
        <option value="">âœ¨ All collections</option>
        <option value="existing_db">ğŸ—„ï¸ Database Tables ({{.Stats.ExistingDB}})</option>
        <option value="existing_local">ğŸ“ Local Files ({{.Stats.ExistingLocal}})</option>
        <option value="potential_v6">âš™ï¸ v6 Jobs ({{.Stats.PotentialV6}})</option>
        <option value="external_api">ğŸ”Œ External APIs ({{.Stats.ExternalAPI}})</option>
        <option value="external_news">ğŸ“° News Sources ({{.Stats.ExternalNews}})</option>
        <option value="external_government">ğŸ›ï¸ Government ({{.Stats.ExternalGov}})</option>
        <option value="external_other">ğŸ”— Other External ({{.Stats.ExternalOther}})</option>
      </select>

      <!-- Format filter -->
      <select id="format" class="select" aria-label="Filter by format">
        <option value="">All formats</option>
        <optgroup label="ğŸ—„ï¸ Database">
          <option value="database">ğŸ“Š Database Tables</option>
        </optgroup>
        <optgroup label="ğŸ“‹ Tabular Data">
          <option value="csv">ğŸ“„ CSV</option>
          <option value="tsv">ğŸ“„ TSV</option>
          <option value="xls">ğŸ“— Excel (XLS)</option>
          <option value="xlsx">ğŸ“— Excel (XLSX)</option>
          <option value="json">ğŸ“ JSON</option>
        </optgroup>
        <optgroup label="ğŸŒ Geospatial Data">
          <option value="parquet">ğŸ—‚ï¸ Parquet</option>
          <option value="shapefile">ğŸ—ºï¸ Shapefile</option>
          <option value="geopackage">ğŸ“¦ GeoPackage</option>
          <option value="filegdb">ğŸ—ƒï¸ File Geodatabase</option>
          <option value="geojson">ğŸŒ GeoJSON</option>
        </optgroup>
        <optgroup label="ğŸ“„ Documents">
          <option value="pdf">ğŸ“• PDF</option>
          <option value="image">ğŸ–¼ï¸ Image</option>
          <option value="html">ğŸŒ HTML</option>
        </optgroup>
        <optgroup label="ğŸ”— External Sources">
          <option value="api">ğŸ”Œ API</option>
          <option value="news">ğŸ“° News</option>
          <option value="academic">ğŸ“ Academic</option>
          <option value="government">ğŸ›ï¸ Government</option>
        </optgroup>
      </select>

      <!-- Status filter -->
      <select id="status" class="select" aria-label="Filter by status">
        <option value="">All statuses</option>
        <option value="implemented">âœ“ Implemented</option>
        <option value="draft">ğŸ“ Draft</option>
        <option value="potential">ğŸ’¡ Potential</option>
      </select>

      <!-- V6 Job Type filter -->
      <select id="jobType" class="select" aria-label="Filter by v6 job type">
        <option value="">All job types</option>
        <option value="bootstrap">ğŸ”§ Bootstrap (441)</option>
        <option value="collectors">ğŸ“¡ Collectors (164)</option>
        <option value="run">â–¶ï¸ Run (18)</option>
        <option value="inference">ğŸ§  Inference (4)</option>
      </select>

      <!-- Sort -->
      <select id="sort" class="select" aria-label="Sort datasets">
        <option value="name_asc">Name (Aâ†’Z)</option>
        <option value="name_desc">Name (Zâ†’A)</option>
        <option value="updated_desc">Recently Updated</option>
      </select>
    </div>
  </section>

  <!-- Results grid -->
  <section class="card card-compact">
    <div id="resultCount" class="muted" style="margin-bottom:12px">
      Showing <span id="showing">{{.Stats.Total}}</span> of <span id="total">{{.Stats.Total}}</span> datasets
    </div>

    <ul id="catalogGrid" class="grid-cards reset" style="gap:12px;list-style:none;margin:0;padding:0">
      {{range .Records}}
        <li class="card card-compact dataset"
            data-name="{{.Properties.Title}}"
            data-collection="{{.Properties.Collection}}"
            data-format="{{.Properties.GROMetadata.DataFormat}}"
            data-status="{{.Properties.GROMetadata.ImplementationStatus}}"
            data-jobtype="{{.Properties.GROMetadata.V6JobType}}"
            data-country="{{.Properties.GROMetadata.Country}}"
            style="display:flex;flex-direction:column;gap:10px">

          <!-- Title -->
          <h3 style="margin:0;font-size:15px;line-height:1.3;font-weight:700">
            <a href="/dataset/{{.ID}}" style="color:var(--accent);text-decoration:none">
              {{.Properties.Title}}
            </a>
          </h3>

          <!-- Metadata chips -->
          <div class="chips" style="gap:4px;flex-wrap:wrap">
            <!-- Collection -->
            <span class="chip chip-sm" style="background:#eff6ff;color:#1e40af;border-color:#bfdbfe">
              {{.Properties.Collection}}
            </span>

            <!-- Format -->
            {{if .Properties.GROMetadata.DataFormat}}
              <span class="chip chip-sm" style="font-family:monospace;font-size:9px;background:#f5f5f5;color:#404040">
                {{.Properties.GROMetadata.DataFormat}}
              </span>
            {{end}}

            <!-- Status badge -->
            {{if eq .Properties.GROMetadata.ImplementationStatus "implemented"}}
              <span class="chip chip-sm" style="background:#dcfce7;color:#15803d;border-color:#bbf7d0">
                âœ“ Implemented
              </span>
            {{else if eq .Properties.GROMetadata.ImplementationStatus "draft"}}
              <span class="chip chip-sm" style="background:#fef3c7;color:#92400e;border-color:#fde68a">
                Draft
              </span>
            {{else}}
              <span class="chip chip-sm" style="background:#f3f4f6;color:#6b7280;border-color:#e5e7eb">
                Potential
              </span>
            {{end}}
          </div>

          <!-- Description (clean, without metadata) -->
          {{if .Properties.Abstract}}
            {{$cleanDesc := cleanAbstract .Properties.Abstract}}
            {{if $cleanDesc}}
              <p class="snippet" style="margin:0;font-size:13px;color:#374151;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">
                {{$cleanDesc}}
              </p>
            {{end}}
          {{end}}

          <!-- Metadata pills (if metadata found in abstract) -->
          {{if .Properties.Abstract}}
            {{if hasMetadata .Properties.Abstract}}
              <div class="chips" style="gap:4px;flex-wrap:wrap">
                {{$rows := extractMetadata .Properties.Abstract "Rows"}}
                {{if $rows}}
                  <span class="chip chip-sm" style="font-size:9px;background:#f0fdf4;border:1px solid #bbf7d0;color:#15803d">
                    <span style="opacity:0.7">ROWS:</span> <span style="font-weight:600;margin-left:2px">{{$rows}}</span>
                  </span>
                {{end}}

                {{$features := extractMetadata .Properties.Abstract "features"}}
                {{if $features}}
                  <span class="chip chip-sm" style="font-size:9px;background:#f0fdf4;border:1px solid #bbf7d0;color:#15803d">
                    <span style="opacity:0.7">FEATURES:</span> <span style="font-weight:600;margin-left:2px">{{$features}}</span>
                  </span>
                {{end}}

                {{$size := extractMetadata .Properties.Abstract "Size"}}
                {{if $size}}
                  <span class="chip chip-sm" style="font-size:9px;background:#fef3c7;border:1px solid #fde68a;color:#92400e">
                    <span style="opacity:0.8">SIZE:</span> <span style="font-weight:600;margin-left:2px">{{$size}}</span>
                  </span>
                {{end}}

                {{$columns := extractMetadata .Properties.Abstract "Columns"}}
                {{if $columns}}
                  <span class="chip chip-sm" style="font-size:9px;background:#f5f3ff;border:1px solid #ddd6fe;color:#6b21a8">
                    <span style="opacity:0.8">COLS:</span> <span style="font-weight:600;margin-left:2px">{{$columns}}</span>
                  </span>
                {{end}}

                {{$fields := extractMetadata .Properties.Abstract "fields"}}
                {{if $fields}}
                  <span class="chip chip-sm" style="font-size:9px;background:#f5f3ff;border:1px solid #ddd6fe;color:#6b21a8">
                    <span style="opacity:0.8">FIELDS:</span> <span style="font-weight:600;margin-left:2px">{{$fields}}</span>
                  </span>
                {{end}}

                {{$schema := extractMetadata .Properties.Abstract "Schema"}}
                {{if $schema}}
                  <span class="chip chip-sm" style="font-size:9px;background:#f0f9ff;border:1px solid #bae6fd;color:#075985">
                    <span style="opacity:0.7">SCHEMA:</span> <span style="font-weight:600;margin-left:2px;font-family:monospace">{{$schema}}</span>
                  </span>
                {{end}}
              </div>
            {{end}}
          {{end}}

          <!-- Location chips -->
          {{if or .Properties.GROMetadata.Country .Properties.GROMetadata.Continent}}
            <div class="chips" style="gap:3px;flex-wrap:wrap">
              {{if .Properties.GROMetadata.Continent}}
                <span class="chip chip-sm" style="font-size:9px;background:#fef2f2;color:#991b1b;border-color:#fecaca">
                  {{.Properties.GROMetadata.Continent}}
                </span>
              {{end}}
              {{if .Properties.GROMetadata.Country}}
                <span class="chip chip-sm" style="font-size:10px;background:#e0f2fe;border-color:#bae6fd;color:#075985">
                  {{upper .Properties.GROMetadata.Country}}
                </span>
              {{end}}
            </div>
          {{end}}
        </li>
      {{end}}
    </ul>

    <!-- No results message -->
    <div id="noResults" class="hidden" style="text-align:center;padding:40px;color:var(--muted)">
      <p style="font-size:16px;margin:0">No datasets match your filters</p>
      <p style="font-size:13px;margin:8px 0 0">Try adjusting your search or filters</p>
    </div>
  </section>
{{end}}

{{define "scripts_extra"}}
<script>
// Client-side filtering (just like Explore!) + URL state management
const datasets = Array.from(document.querySelectorAll('.dataset'));
const q = document.getElementById('q');
const collection = document.getElementById('collection');
const format = document.getElementById('format');
const status = document.getElementById('status');
const jobType = document.getElementById('jobType');
const sort = document.getElementById('sort');
const showing = document.getElementById('showing');
const noResults = document.getElementById('noResults');
const catalogGrid = document.getElementById('catalogGrid');

// Load state from URL on page load
function loadStateFromURL() {
  const params = new URLSearchParams(window.location.search);
  if (params.has('q')) q.value = params.get('q');
  if (params.has('collection')) collection.value = params.get('collection');
  if (params.has('format')) format.value = params.get('format');
  if (params.has('status')) status.value = params.get('status');
  if (params.has('jobType')) jobType.value = params.get('jobType');
  if (params.has('sort')) sort.value = params.get('sort');
}

// Update URL with current filter state
function updateURL() {
  const params = new URLSearchParams();
  if (q.value) params.set('q', q.value);
  if (collection.value) params.set('collection', collection.value);
  if (format.value) params.set('format', format.value);
  if (status.value) params.set('status', status.value);
  if (jobType.value) params.set('jobType', jobType.value);
  if (sort.value !== 'name_asc') params.set('sort', sort.value);

  const url = params.toString() ? `?${params.toString()}` : window.location.pathname;
  window.history.replaceState({}, '', url);
}

function filter() {
  const query = q.value.toLowerCase().trim();
  const collVal = collection.value;
  const fmtVal = format.value;
  const statVal = status.value;
  const jobVal = jobType.value;

  let visible = 0;
  datasets.forEach(d => {
    const name = (d.dataset.name || '').toLowerCase();
    const coll = d.dataset.collection || '';
    const fmt = d.dataset.format || '';
    const stat = d.dataset.status || '';
    const job = d.dataset.jobtype || '';

    const matchQuery = !query || name.includes(query);
    const matchColl = !collVal || coll === collVal;
    const matchFmt = !fmtVal || fmt === fmtVal;
    const matchStat = !statVal || stat === statVal;
    const matchJob = !jobVal || job === jobVal;

    if (matchQuery && matchColl && matchFmt && matchStat && matchJob) {
      d.style.display = '';
      visible++;
    } else {
      d.style.display = 'none';
    }
  });

  showing.textContent = visible;
  noResults.style.display = visible === 0 ? 'block' : 'none';
  catalogGrid.style.display = visible === 0 ? 'none' : 'grid';

  updateURL();
}

q.addEventListener('input', filter);
collection.addEventListener('change', filter);
format.addEventListener('change', filter);
status.addEventListener('change', filter);
jobType.addEventListener('change', filter);

// Sorting
sort.addEventListener('change', () => {
  const val = sort.value;
  const sorted = [...datasets].sort((a, b) => {
    const nameA = (a.dataset.name || '').toLowerCase();
    const nameB = (b.dataset.name || '').toLowerCase();

    if (val === 'name_asc') return nameA.localeCompare(nameB);
    if (val === 'name_desc') return nameB.localeCompare(nameA);
    return 0;
  });

  sorted.forEach(d => catalogGrid.appendChild(d));
  updateURL();
});

// Load state and apply filters on page load
loadStateFromURL();
filter();
</script>
{{end}}
